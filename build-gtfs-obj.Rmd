---
title: "Building gtfs and tidygtfs objects"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load test GTFS

```{r}
library(tidyverse)
library(tidytransit)

local_gtfs_path <- system.file("extdata", "google_transit_nyc_subway.zip", package = "tidytransit")
gtfs <- read_gtfs(local_gtfs_path)
names(gtfs)

```

## Explore GTFS tables.

The `.` sublist is for storing additional tables (additional to what? anything not strictly required?)

```{r}
gtfs$.
```

```{r}
gtfs$routes %>% class()
class(gtfs)
```

These are standard tibbles, not data.table as used by gtfsio for reading. The gtfs object has class `tidygtfs` as well as inheriting from `gtfs`.

## Try creating a new tidygtfs object

```{r}
txt_files <- list(
  agency = gtfs$agency,
  stops = gtfs$stops,
  routes = gtfs$routes,
  trips = gtfs$trips,
  stop_times = gtfs$stop_times,
  calendar = gtfs$calendar
)

new_gtfs <- gtfsio::new_gtfs(txt_files)
class(new_gtfs)

```

This is *just* a `gtfs` object, without the `tidygtfs` class. But it still validates okay:

```{r}
validate_gtfs(new_gtfs)
```

It seems `tidytransit` doesn't do too much more than gtfsio: just converts to tibble, convert dates and times, adds validation results and an empty `.` slot. However, those conversions rely on the table objects inheriting from `data.table`.

```{r}
read_gtfs
```

## Exporting as valid GTFS files

It might be quite a bit of work to create valid `tidygtfs` objects. It could be worth it if we want to use any of the `tidytransit` functions for analysis, but for just exporting to GTFS files for OTP use, it might be easier just to adapt a simplified version of the code from `gtfsio::export_gtfs`:

```{r}
gtfsio::export_gtfs
```

Might it be easier to use `readr::write_csv()` rather than `data.table::fwrite()`?

### Important notes:

* Dates in GTFS files need to be written as `yyyymmdd` text: beware of databases converting these to Date object-style integers.
* GTFS times are written as `hh:mm:ss` text: beware of conversions to `hms` objects.
